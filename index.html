<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Family Tree Editor (Firebase & D3.js)</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load D3.js v7 library -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    /* Custom styling for the tree container */
    #tree-container { 
        width: 100%; 
        height: 90vh; 
        background-color: #f7f7f7;
        border-radius: 0.5rem;
        overflow: hidden; 
    }
    
    /* D3 Styles */
    .link {
      fill: none;
      stroke: #9d9d9d;
      stroke-width: 1.5px;
    }
    .node rect {
      fill: #fff;
      stroke: #3182CE;
      stroke-width: 2px;
      cursor: default;
      rx: 6; ry: 6;
    }
    /* Admin mode indicates nodes are clickable */
    .node--admin rect {
      stroke: #E53E3E; /* Red border */
      stroke-width: 3px;
      cursor: pointer;
    }
    .node text {
      font-size: 11px; font-weight: 500; fill: #333; pointer-events: none; 
      /* No need for dominant-baseline as we handle centering with tspan dy attributes */
    }
    .node--root rect { fill: #3182CE; stroke: #2C5282; }
    .node--root text { fill: white; font-weight: bold; }
    .node--root.node--admin rect { stroke: #D53F8C; }

    /* Modal Styling */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 450px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body class="bg-gray-100 flex flex-col items-center p-4 min-h-screen font-sans">
  
  <header class="mb-6 text-center w-full max-w-6xl">
      <h1 class="text-3xl font-bold text-indigo-700">The Family Tree of Tjandra</h1>
      
      <div id="controls" class="mt-4 flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
          
          <!-- Public Request Button (Always Visible) -->
          <a href="mailto:bryantaryadi25@gmail.com?subject=New%20Family%20Member%20Addition%20Request%20(Jia%20Liok%20Ngo%20Tree)&body=Hello%20Bryant%2C%0D%0A%0D%0AI%20would%20like%20to%20request%20the%20addition%20of%20a%20new%20family%20member%20to%20the%20tree.%0D%0A%0D%0A---%20Required%20Details%20---%0D%0A-Name%20of%20New%20Member%3A%0D%0A-Parent's%20Name%20(Existing%20on%20Tree)%3A%0D%0A-Relationship%20(e.g.%2C%20Child%2C%20Spouse)%3A%0D%0A---%20%0D%0A%0D%0AThanks!" 
             class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition duration-150">
              + Request New Member Addition
          </a>
          
          <!-- Admin Controls Group -->
          <div id="adminControls" class="flex items-center space-x-2">
            
            <!-- Password Change Button -->
            <button id="passwordButton" class="hidden items-center px-3 py-2 text-xs font-medium rounded-md text-gray-800 bg-yellow-400 hover:bg-yellow-500 transition duration-150" onclick="openPasswordChangeModal()">
                Password
            </button>

            <!-- Admin Sign Out Button -->
            <button id="signOutButton" class="hidden items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 transition duration-150" onclick="adminSignOut()">
                Sign Out
            </button>
          </div>

          <!-- Admin Login Button -->
          <button id="loginButton" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150" onclick="openLoginModal()">
              Admin Login
          </button>
          
          <div id="authStatus" class="text-sm text-gray-500">Initializing...</div>
      </div>
  </header>

  <div id="tree-container" class="w-full max-w-6xl shadow-xl rounded-lg border border-gray-200">
    <svg id="tree"></svg>
  </div>
  
  <!-- Modal for Admin Login -->
  <div id="loginModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-indigo-700">Admin Login</h2>
      
      <div class="space-y-4">
        <div>
          <label for="adminEmail" class="block text-sm font-medium text-gray-700">Email</label>
          <input type="email" id="adminEmail" placeholder="Enter admin email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label for="adminPassword" class="block text-sm font-medium text-gray-700">Password</label>
          <input type="password" id="adminPassword" placeholder="Enter password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        </div>
      </div>

      <div id="loginError" class="text-red-500 text-sm mt-4 hidden"></div>

      <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closeLoginModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
        <button onclick="handleAdminLogin()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Login</button>
      </div>
    </div>
  </div>

  <!-- Modal for Password Change -->
  <div id="passwordChangeModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-yellow-700">Change Admin Password</h2>
      <p class="text-sm text-gray-600 mb-4">You must enter your current password to confirm your identity.</p>

      <div class="space-y-4">
        <div>
          <label for="currentPassword" class="block text-sm font-medium text-gray-700">Current Password</label>
          <input type="password" id="currentPassword" placeholder="Enter current password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <div>
          <label for="newPassword" class="block text-sm font-medium text-gray-700">New Password (Min 6 chars)</label>
          <input type="password" id="newPassword" placeholder="Enter new password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
        </div>
        <div>
          <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700">Confirm New Password</label>
          <input type="password" id="confirmNewPassword" placeholder="Re-enter new password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500">
        </div>
      </div>

      <div id="passwordChangeError" class="text-red-500 text-sm mt-4 hidden"></div>
      <div id="passwordChangeSuccess" class="text-green-600 text-sm mt-4 hidden"></div>

      <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closePasswordChangeModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancel</button>
        <button onclick="changePassword()" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">Update Password</button>
      </div>
    </div>
  </div>

  <!-- Modal for Node Editing -->
  <div id="nodeEditModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-red-700">Edit Member: <span id="currentMemberName" class="font-extrabold"></span></h2>
      <input type="hidden" id="currentMemberPath">

      <div class="space-y-4">
        
        <div>
          <label for="newName" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="newName" placeholder="Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>

        <div>
          <label for="newSpouse" class="block text-sm font-medium text-gray-700">Spouse Name</label>
          <input type="text" id="newSpouse" placeholder="Spouse Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>
        
        <div>
          <label for="newDob" class="block text-sm font-medium text-gray-700">Date of Birth (e.g., YYYY-MM-DD)</label>
          <input type="text" id="newDob" placeholder="Date of Birth" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>
        
        <button onclick="handleNodeAction('updateDetails')" class="mt-2 w-full px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition">Save Name/Details</button>
        
        <hr class="border-gray-200">

        <div>
          <label for="childName" class="block text-sm font-medium text-gray-700">Add New Child</label>
          <input type="text" id="childName" placeholder="New Child's Name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
          <button onclick="handleNodeAction('addChild')" class="mt-2 w-full px-4 py-2 text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 transition">Add Child</button>
        </div>

        <hr class="border-gray-200">

        <div id="deleteSection">
          <p class="text-red-500 text-sm font-semibold mb-2">Danger Zone: Remove Member</p>
          <button onclick="handleNodeAction('delete')" class="w-full px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 transition">Delete Member (and all descendants)</button>
        </div>

      </div>

      <div id="nodeEditError" class="text-red-500 text-sm mt-4 hidden"></div>
      <div id="nodeEditSuccess" class="text-green-600 text-sm mt-4 hidden"></div>

      <div class="flex justify-end mt-6">
        <button onclick="closeNodeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Done</button>
      </div>
    </div>
  </div>

  <div id="infoModal" class="modal-overlay hidden">
    <div class="modal-content">
      <h2 class="text-xl font-bold mb-4 text-blue-700">Member Details: <span id="infoMemberName" class="font-extrabold"></span></h2>
      
      <div class="space-y-3">
        <p class="text-gray-700">
          <span class="font-semibold">Spouse:</span> 
          <span id="infoSpouseName" class="text-gray-900">N/A</span>
        </p>
        <p class="text-gray-700">
          <span class="font-semibold">Date of Birth:</span> 
          <span id="infoDOB" class="text-gray-900">N/A</span>
        </p>
      </div>

      <div class="flex justify-end mt-6">
        <button onclick="closeInfoModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase and D3 Logic -->
  <script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyD76IQ5BcFGLo7LKPJF8rvmRDYHSZrNAY0",
        authDomain: "jandrafamilytree.firebaseapp.com",
        projectId: "tjandrafamilytree",
        storageBucket: "tjandrafamilytree.firebasestorage.app",
        messagingSenderId: "294767433364",
        appId: "1:294767433364:web:9b93d0706fbde096c64681",
        // measurementId: "G-Z2LLBDS6RQ"
    };
    
    // --- ADMIN LIST: Add UIDs of all users who should have edit permissions here ---
    const ADMIN_UIDS = [
        "SAwieXn2nDQes1SrLkPaXdnFoY22"
    ];

    const appId = firebaseConfig.projectId;
    
    // --- FIREBASE SETUP ---
    setLogLevel('debug'); 
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Document reference 
    const treeDocRef = doc(db, `artifacts/${appId}/public/data/familyTree/current`);
    
    let currentTreeData = null;
    let userId = null;
    let isAdminMode = false;

    let isVerticalLayout = false; // Tracks the current layout state

    // Global function to toggle the layout direction
    window.toggleLayout = function() {
        isVerticalLayout = !isVerticalLayout;
        const icon = document.getElementById('layout-icon');
        
        if (isVerticalLayout) {
            // Tree is NOW Vertical. Button should show the icon for the next state: Horizontal.
            icon.src = 'horizontal.png';
            icon.alt = 'Horizontal Layout Icon';
        } else {
            // Tree is NOW Horizontal. Button should show the icon for the next state: Vertical.
            icon.src = 'vertical.png';
            icon.alt = 'Vertical Layout Icon';
        }
        
        // Redraw the tree with the new layout setting
        if (currentTreeData) {
            drawTree(currentTreeData);
        }
    }

    // --- UTILITY FUNCTIONS FOR TREE MANIPULATION ---
    
    // Recursive function to find the node and its parent, using an array of names as the path
    function findNodeAndParent(node, path, index = 0, parent = null) {
        if (!node || index >= path.length) return { node: null, parent: null };
        
        if (node.name === path[index]) {
            if (index === path.length - 1) {
                // Found the target node
                return { node, parent };
            }
            
            // Continue search in children
            if (node.children) {
                for (const child of node.children) {
                    const result = findNodeAndParent(child, path, index + 1, node);
                    if (result.node) {
                        return result;
                    }
                }
            }
        }
        return { node: null, parent: null };
    }

    // Function to create a unique path (array of names from root to node) for a D3 node
    function getPath(d) {
        let path = [];
        let current = d;
        while (current) {
            path.unshift(current.data.name);
            current = current.parent;
        }
        return path;
    }

    // --- MODAL & ACTION HANDLERS ---

    // Global variable to store the path of the node currently being edited
    let activeNodePath = [];

    // --- NEW INFO MODAL HANDLERS (PUBLIC) ---
    window.openInfoModal = function(d) {
        const data = d.data;
        
        document.getElementById('infoMemberName').textContent = data.name || 'N/A';
        document.getElementById('infoSpouseName').textContent = data.spouse && data.spouse.trim() ? data.spouse : 'N/A';
        document.getElementById('infoDOB').textContent = data.dob && data.dob.trim() ? data.dob : 'N/A';

        document.getElementById('infoModal').classList.remove('hidden');
    }

    window.closeInfoModal = function() {
        document.getElementById('infoModal').classList.add('hidden');
    }

    window.openNodeEditModal = function(d) {
        activeNodePath = getPath(d);
        const memberName = d.data.name;
        
        document.getElementById('currentMemberName').textContent = memberName;
        // Populate ALL editable fields
        document.getElementById('newName').value = d.data.name;
        document.getElementById('newSpouse').value = d.data.spouse || ''; // Populate new field
        document.getElementById('newDob').value = d.data.dob || '';       // Populate new field
        
        document.getElementById('childName').value = '';
        document.getElementById('nodeEditError').classList.add('hidden');
        document.getElementById('nodeEditSuccess').classList.add('hidden');
        
        // Hide delete option for the root node (first element of the path array)
        if (activeNodePath.length === 1) {
             document.getElementById('deleteSection').classList.add('hidden');
        } else {
             document.getElementById('deleteSection').classList.remove('hidden');
        }

        document.getElementById('nodeEditModal').classList.remove('hidden');
    }

    window.closeNodeEditModal = function() {
        document.getElementById('nodeEditModal').classList.add('hidden');
    }

    window.handleNodeAction = async function(action) {
        const errorElement = document.getElementById('nodeEditError');
        const successElement = document.getElementById('nodeEditSuccess');
        errorElement.classList.add('hidden');
        successElement.classList.add('hidden');
        
        // Use a mutable copy of the current data
        let newTreeData = JSON.parse(JSON.stringify(currentTreeData)); 

        const { node: targetNode, parent: targetParent } = findNodeAndParent(newTreeData, activeNodePath);

        if (!targetNode) {
            errorElement.textContent = "Error: Could not find the selected member in the tree data.";
            errorElement.classList.remove('hidden');
            return;
        }
        
        let shouldSave = false;
        let successMessage = "";

        switch (action) {
            case 'updateDetails': // <-- NEW ACTION CASE
                const newName = document.getElementById('newName').value.trim();
                const newSpouse = document.getElementById('newSpouse').value.trim();
                const newDob = document.getElementById('newDob').value.trim();
                
                if (!newName) {
                    errorElement.textContent = "Name cannot be empty.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // Update the node properties
                targetNode.name = newName;
                targetNode.spouse = newSpouse;
                targetNode.dob = newDob;
                
                shouldSave = true;
                successMessage = "Member details successfully updated!";
                // Update the path reference to the new name for future actions
                activeNodePath[activeNodePath.length - 1] = newName; 
                document.getElementById('currentMemberName').textContent = newName;
                break;

            case 'addChild':
                const childName = document.getElementById('childName').value.trim();
                if (!childName) {
                    errorElement.textContent = "Child's name cannot be empty.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                if (!targetNode.children) {
                    targetNode.children = [];
                }
                // When adding a new child, initialize spouse/dob fields
                targetNode.children.push({ name: childName, spouse: "", dob: "" }); 
                shouldSave = true;
                successMessage = childName + " successfully added as a child!";
                document.getElementById('childName').value = '';
                break;
                
            case 'delete':
                // --- START OF CONFIRMATION STEP ---
                const isConfirmed = confirm(`ARE YOU ABSOLUTELY SURE you want to delete ${targetNode.name} and ALL their descendants? This action cannot be undone.`);
                
                if (!isConfirmed) {
                    // User clicked "Cancel"
                    successElement.textContent = "Deletion cancelled.";
                    successElement.classList.remove('hidden');
                    return; // Exit the function without saving
                }
                // --- END OF CONFIRMATION STEP ---

                if (activeNodePath.length === 1 || !targetParent) {
                    errorElement.textContent = "Cannot delete the root node.";
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                // Remove the node from the parent's children array
                targetParent.children = targetParent.children.filter(child => child.name !== targetNode.name);
                
                // If parent has no more children, remove the children array entirely
                if (targetParent.children.length === 0) {
                    delete targetParent.children;
                }
                
                shouldSave = true;
                successMessage = targetNode.name + " and their descendants have been permanently removed.";
                break;
        }

        if (shouldSave) {
            try {
                const dataToSave = { treeJson: JSON.stringify(newTreeData) };
                await setDoc(treeDocRef, dataToSave, { merge: false });
                currentTreeData = newTreeData; // Update the live variable
                // The onSnapshot listener will redraw the tree.
                console.log("Tree data successfully updated and saved to Firestore.");
            } catch (e) {
                errorElement.textContent = "Error saving data to database.";
                errorElement.classList.remove('hidden');
                console.error("Save Error:", e);
                return; // Stop here if save failed
            }
        }

        successElement.textContent = successMessage;
        successElement.classList.remove('hidden');
    }

    // --- AUTH & LOGIN FUNCTIONS ---

    window.openLoginModal = function() {
        document.getElementById('loginModal').classList.remove('hidden');
        document.getElementById('loginError').classList.add('hidden');
        document.getElementById('adminEmail').value = '';
        document.getElementById('adminPassword').value = '';
    }

    window.closeLoginModal = function() {
        document.getElementById('loginModal').classList.add('hidden');
    }

    window.handleAdminLogin = async function() {
        const emailInput = document.getElementById('adminEmail');
        const passwordInput = document.getElementById('adminPassword');
        const loginError = document.getElementById('loginError');

        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        loginError.classList.add('hidden');
        
        if (!email || !password) {
            loginError.textContent = "Please enter both email and password.";
            loginError.classList.remove('hidden');
            return;
        }

        try {
            await signInWithEmailAndPassword(auth, email, password);
            console.log("Admin signed in successfully!"); 
            closeLoginModal(); 
        } catch (error) {
            console.error("Admin Sign In Error:", error.message);
            loginError.textContent = "Login failed. Check your email and password.";
            loginError.classList.remove('hidden');
        }
    }
    
    window.adminSignOut = async function() {
        try {
            await signOut(auth);
            console.log("Admin signed out successfully!");
        } catch (error) {
            console.error("Sign Out Error:", error.message);
        }
    }

    // Password Change Functions
    window.openPasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').classList.remove('hidden');
        document.getElementById('passwordChangeError').classList.add('hidden');
        document.getElementById('passwordChangeSuccess').classList.add('hidden');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmNewPassword').value = '';
    }

    window.closePasswordChangeModal = function() {
        document.getElementById('passwordChangeModal').classList.add('hidden');
    }

    window.changePassword = async function() {
        const user = auth.currentUser;
        if (!user || !user.email) {
            document.getElementById('passwordChangeError').textContent = "Not signed in or user data missing.";
            document.getElementById('passwordChangeError').classList.remove('hidden');
            return;
        }

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;
        const errorElement = document.getElementById('passwordChangeError');
        const successElement = document.getElementById('passwordChangeSuccess');

        errorElement.classList.add('hidden');
        successElement.classList.add('hidden');

        if (newPassword.length < 6) {
            errorElement.textContent = "New password must be at least 6 characters long.";
            errorElement.classList.remove('hidden');
            return;
        }

        if (newPassword !== confirmNewPassword) {
            errorElement.textContent = "New passwords do not match.";
            errorElement.classList.remove('hidden');
            return;
        }

        try {
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPassword);

            successElement.textContent = "Password successfully updated!";
            successElement.classList.remove('hidden');
            document.getElementById('currentPassword').value = ''; 
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';

            setTimeout(closePasswordChangeModal, 2000); 
            
        } catch (error) {
            console.error("Password Change Error:", error);
            
            let message = "An unknown error occurred.";
            if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = "Current password is incorrect.";
            } else if (error.code === 'auth/requires-recent-login') {
                message = "Please sign out and sign back in before changing your password.";
            } else if (error.code === 'auth/weak-password') {
                message = "The new password is too weak. Please choose a stronger one.";
            } else {
                message = error.message;
            }

            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }
    }


    // Check for existing signed-in user
    onAuthStateChanged(auth, (user) => {
        userId = user ? user.uid : null;
        const authStatusElement = document.getElementById('authStatus');
        const signOutButton = document.getElementById('signOutButton');
        const passwordButton = document.getElementById('passwordButton'); 
        const loginButton = document.getElementById('loginButton');

        const isUserAdmin = userId && ADMIN_UIDS.includes(userId);
        isAdminMode = isUserAdmin;

        // Re-draw the tree to apply the admin styling and click handlers
        if(currentTreeData) {
            drawTree(currentTreeData);
        }

        if (isAdminMode) {
            authStatusElement.innerHTML = `<span class="text-green-600 font-bold">ADMIN MODE (Click a member to edit)</span>`;
            
            signOutButton.classList.remove('hidden'); 
            signOutButton.classList.add('flex');
            passwordButton.classList.remove('hidden'); 
            passwordButton.classList.add('flex');
            loginButton.classList.add('hidden'); 
        } else {
            authStatusElement.innerHTML = `<span class="text-gray-500">View Only Mode</span>`;
            
            signOutButton.classList.add('hidden'); 
            signOutButton.classList.remove('flex');
            passwordButton.classList.add('hidden'); 
            passwordButton.classList.remove('flex');
            loginButton.classList.remove('hidden'); 
        }
    });

    // --- DATA HANDLING (READ) ---
    function loadTreeData() {
        onSnapshot(treeDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                if (data && data.treeJson) {
                    try {
                        const treeObject = JSON.parse(data.treeJson);
                        currentTreeData = treeObject;
                        drawTree(currentTreeData);
                        console.log("Tree data loaded from Firestore.");
                    } catch (e) {
                        console.error("Error parsing JSON data from Firestore:", e);
                    }
                } else {
                    currentTreeData = { name: "Tree Document Empty" };
                    drawTree(currentTreeData);
                }
            } else {
                currentTreeData = JSON.parse(JSON.stringify(initialJsonStructure)); // Initialize with default structure
                drawTree(currentTreeData);
                console.log("Database not initialized. Using default structure.");
            }
        }, (error) => {
            console.error("Firestore Error:", error);
            const authStatusElement = document.getElementById('authStatus');
            
            if (error.code === 'permission-denied') {
                authStatusElement.innerHTML = `<p class="text-xs text-red-500 font-bold mt-1">Error: Permission Denied. Please ensure the Firestore security rules allow unauthenticated public reads.</p>`;
                currentTreeData = { name: "Error: Permission Denied" };
                drawTree(currentTreeData);
            }
        });
        
        window.removeEventListener('resize', resizeHandler);
        window.addEventListener('resize', resizeHandler);
    }

    loadTreeData();

    function resizeHandler() {
        if (currentTreeData) {
            drawTree(currentTreeData);
        }
    }

    // --- D3 LOGIC ---
    const initialJsonStructure = {
        name: "Tjandra", 
        spouse: "",
        dob: "",
        children: [
            { 
                name: "Tjia Hwqi Djien",
                spouse: "",
                dob: ""
            }
        ]
    };

    // Constants for dynamic node sizing and layout
    const LINE_HEIGHT = 14; 
    const X_PADDING = 12; // Horizontal padding inside the box
    const Y_PADDING = 12; // Vertical padding inside the box
    const MIN_NODE_WIDTH = 100; // Minimum width for the name box

    function drawTree(data) {
        if (!data || !data.name) return; 

        const container = document.getElementById('tree-container');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const svg = d3.select("#tree")
            .attr("width", width)
            .attr("height", height);

        svg.selectAll('*').remove();

        // Dynamically set the initial translation for centering/offset
        let initialTranslateX, initialTranslateY;
        
        if (isVerticalLayout) {
            // For vertical layout: translate to the center-top
            initialTranslateX = width / 2;
            initialTranslateY = 40;
        } else {
            // For horizontal layout: translate to the left-center
            initialTranslateX = 40;
            initialTranslateY = height / 2; // Center vertically now
        }

        const g = svg.append("g")
            .attr("transform", `translate(${initialTranslateX},${initialTranslateY})`); 

        const zoom = d3.zoom()
            .scaleExtent([0.1, 4]) 
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Constants for dynamic node sizing and layout (from your previous code)
        const LINE_HEIGHT = 14; 
        const X_PADDING = 12;
        const Y_PADDING = 12;
        const MIN_NODE_WIDTH = 100;
        
        // Define separation based on layout
        const separationDistance = 160;
        const nodeSeparation = 100;

        let treeLayout;
        let linkGenerator;
        let nodeTranslation;

        if (isVerticalLayout) {
            // Vertical Layout (Top-to-Bottom)
            treeLayout = d3.tree()
                .size([width - 80, height - 80]); // Use full SVG size minus margins
                
            // Use .nodeSize() to control separation, but we must use .size() with the full dimensions first
            // Now, we'll re-apply the layout with nodeSize to control spacing consistently
            treeLayout = d3.tree()
                .nodeSize([nodeSeparation, separationDistance]);
                
            linkGenerator = d3.linkVertical() // Use vertical link for T-B
                .x(d => d.x) 
                .y(d => d.y);
            
            nodeTranslation = d => `translate(${d.x},${d.y})`; // X is horizontal, Y is vertical

        } else {
            // Horizontal Layout (Left-to-Right) - Your original
            treeLayout = d3.tree()
                .nodeSize([nodeSeparation, separationDistance]); // [vertical, horizontal] node separation
                
            linkGenerator = d3.linkHorizontal() // Use horizontal link for L-R
                .x(d => d.y) 
                .y(d => d.x);
            
            nodeTranslation = d => `translate(${d.y},${d.x})`; // X is vertical, Y is horizontal (swapped)
        }
            
        const root = d3.hierarchy(data);
        treeLayout(root);

        // Draw Links
        g.selectAll(".link")
            .data(root.links()) 
            .enter().append("path")
            .attr("class", "link")
            .attr("d", linkGenerator); // Use the dynamic link generator

        // Draw Nodes
        const node = g.selectAll(".node")
            .data(root.descendants()) 
            .enter().append("g")
            .attr("class", d => "node" + (d.depth === 0 ? " node--root" : "") + (isAdminMode ? " node--admin" : ""))
            .attr("transform", nodeTranslation); // Use the dynamic translation

        
        // --- TEXT WRAPPING AND DIMENSION CALCULATION (UNCHANGED) ---
        
        // 1. Append the text element first
        node.append("text")
            .attr("class", "node-text")
            .text(d => d.data.name)
            .attr("text-anchor", "middle")
            .each(function(d) {
                const textElement = d3.select(this);
                // Split name by space to create individual lines
                const words = d.data.name.split(/\s+/).filter(w => w.length > 0);
                const numLines = words.length;

                // Calculate the initial vertical offset to center the block of text within the node
                const initialDyOffset = -((numLines - 1) * LINE_HEIGHT / 2);

                textElement.text(null); // Clear the initial text

                words.forEach((word, i) => {
                    textElement.append("tspan")
                        .attr("x", 0)
                        // The first tspan uses the calculated initial offset. Subsequent tspans use LINE_HEIGHT
                        .attr("dy", i === 0 ? `${initialDyOffset}px` : `${LINE_HEIGHT}px`)
                        .text(word);
                });
                
                // Calculate required dimensions
                const requiredHeight = numLines * LINE_HEIGHT + Y_PADDING;
                const requiredWidth = MIN_NODE_WIDTH; 

                // Store dimensions on the node object for the rectangle
                d.nodeDimensions = { width: requiredWidth, height: requiredHeight };
            });

        // 2. Insert the rectangle based on the calculated dimensions
        node.insert("rect", ":first-child") // Insert rect before text
            .attr("width", d => d.nodeDimensions.width)
            .attr("height", d => d.nodeDimensions.height)
            .attr("x", d => -(d.nodeDimensions.width / 2))
            .attr("y", d => -(d.nodeDimensions.height / 2));

        // Attach click handler based on the user mode
        if (isAdminMode) {
            // Admin mode: opens the editor modal
            node.on('click', (event, d) => {
                event.stopPropagation(); 
                openNodeEditModal(d);
            });
        } else {
            // Public mode: opens the read-only info modal
            node.on('click', (event, d) => {
                event.stopPropagation(); 
                openInfoModal(d);
            });
        }
    }
  </script>

  <div id="layout-controls" class="fixed bottom-4 right-4 z-50">
      <button id="layout-toggle-button" 
              class="p-3 font-medium rounded-full text-white bg-purple-600 hover:bg-purple-700 transition duration-150 shadow-lg flex items-center justify-center w-12 h-12" 
              onclick="toggleLayout()"
              title="Switch Layout">
          <img id="layout-icon" src="vertical.png" alt="Vertical Layout Icon" class="w-6 h-6">
      </button>
  </div>
</body>
</html>